# 🚀 Deployment Guide for Node 17.9.1 Server

## 📋 Prerequisites

- Node.js 17.9.1 (installed on server)
- PHP 8.1+ with required extensions
- Composer
- MySQL/SQLite database
- Web server (Nginx/Apache)

## 🎯 Quick Deployment

### Option 1: Using Deployment Script (Recommended)

```bash
# 1. Upload project to server
# 2. Navigate to project directory
cd /path/to/spa-app

# 3. Run deployment script
./deploy.sh
```

### Option 2: Manual Deployment

```bash
# 1. Install Node dependencies
rm -rf node_modules package-lock.json
npm install

# 2. Build assets (try normal build first)
npm run build

# If you get OpenSSL errors, use:
npm run build:node17
# OR
NODE_OPTIONS=--openssl-legacy-provider npm run build

# 3. Install PHP dependencies
composer install --no-dev --optimize-autoloader

# 4. Setup environment
cp .env.example .env
php artisan key:generate

# 5. Configure database in .env
# DB_CONNECTION=mysql
# DB_HOST=127.0.0.1
# DB_PORT=3306
# DB_DATABASE=your_database
# DB_USERNAME=your_username
# DB_PASSWORD=your_password

# 6. Run migrations
php artisan migrate --force

# 7. Optimize Laravel
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 8. Generate API docs
php artisan l5-swagger:generate

# 9. Set permissions
chmod -R 755 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

## 🔧 Configuration

### 1. Environment Variables (.env)

```bash
APP_NAME="Crypto App"
APP_ENV=production
APP_KEY=base64:... # Generated by php artisan key:generate
APP_DEBUG=false
APP_URL=https://yourdomain.com

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=crypto_db
DB_USERNAME=crypto_user
DB_PASSWORD=your_secure_password

# Session
SESSION_DRIVER=database
SESSION_LIFETIME=120

# Cache
CACHE_DRIVER=file
QUEUE_CONNECTION=sync
```

### 2. Nginx Configuration

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com;
    root /var/www/spa-app/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

### 3. Apache Configuration (.htaccess)

Already included in `public/.htaccess`

## 🐛 Troubleshooting

### Issue 1: OpenSSL Error

**Error:**
```
Error: error:0308010C:digital envelope routines::unsupported
```

**Solution:**
```bash
# Use Node 17 compatible build
npm run build:node17

# OR set environment variable
export NODE_OPTIONS=--openssl-legacy-provider
npm run build
```

### Issue 2: Vite Build Fails

**Solution:**
```bash
# Clear cache and reinstall
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
npm run build
```

### Issue 3: Assets Not Loading

**Solution:**
```bash
# Check build directory
ls -la public/build/

# Rebuild assets
npm run build

# Clear Laravel cache
php artisan cache:clear
php artisan view:clear
```

### Issue 4: 500 Internal Server Error

**Solution:**
```bash
# Check Laravel logs
tail -f storage/logs/laravel.log

# Fix permissions
chmod -R 755 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache

# Clear and cache config
php artisan config:clear
php artisan config:cache
```

### Issue 5: Database Connection Failed

**Solution:**
```bash
# Test database connection
php artisan tinker
>>> DB::connection()->getPdo();

# Check .env file
cat .env | grep DB_

# Run migrations
php artisan migrate --force
```

## 📦 Package Versions (Node 17.9.1 Compatible)

```json
{
  "devDependencies": {
    "vite": "^5.4.11",           // Downgraded from 7.x
    "laravel-vite-plugin": "^1.0.5",  // Downgraded from 2.x
    "tailwindcss": "^4.0.0",
    "axios": "^1.6.0",
    "concurrently": "^9.0.1"
  },
  "dependencies": {
    "vue": "^2.7.16",
    "vue-router": "^3.6.5",
    "vuex": "^3.6.2"
  }
}
```

## 🔍 Verification Checklist

After deployment, verify:

- [ ] Website loads: `https://yourdomain.com`
- [ ] Login page works: `https://yourdomain.com/login`
- [ ] API documentation: `https://yourdomain.com/api/documentation`
- [ ] Assets load correctly (check browser console)
- [ ] Database connection works
- [ ] Authentication works (login/register)
- [ ] Dashboard loads after login
- [ ] No errors in Laravel logs: `storage/logs/laravel.log`
- [ ] No errors in web server logs

## 🚀 Production Optimization

### 1. Enable OPcache (PHP)

```ini
; php.ini
opcache.enable=1
opcache.memory_consumption=256
opcache.max_accelerated_files=20000
opcache.validate_timestamps=0
```

### 2. Use Redis for Cache (Optional)

```bash
# Install Redis
apt-get install redis-server

# Update .env
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
```

### 3. Enable Gzip Compression (Nginx)

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
```

### 4. Setup SSL (Let's Encrypt)

```bash
# Install certbot
apt-get install certbot python3-certbot-nginx

# Get certificate
certbot --nginx -d yourdomain.com

# Auto-renewal
certbot renew --dry-run
```

## 📊 Monitoring

### Check Application Status

```bash
# Check if app is running
curl -I https://yourdomain.com

# Check API
curl https://yourdomain.com/api/documentation

# Check Laravel queue (if using)
php artisan queue:work --daemon
```

### Log Files

```bash
# Laravel logs
tail -f storage/logs/laravel.log

# Nginx access log
tail -f /var/log/nginx/access.log

# Nginx error log
tail -f /var/log/nginx/error.log

# PHP-FPM log
tail -f /var/log/php8.1-fpm.log
```

## 🔄 Updates & Maintenance

### Deploying Updates

```bash
# 1. Pull latest code
git pull origin main

# 2. Install dependencies
composer install --no-dev --optimize-autoloader
npm install

# 3. Rebuild assets
npm run build

# 4. Run migrations
php artisan migrate --force

# 5. Clear and cache
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 6. Regenerate API docs
php artisan l5-swagger:generate

# 7. Restart services
sudo systemctl restart php8.1-fpm
sudo systemctl reload nginx
```

### Database Backup

```bash
# Backup database
php artisan db:backup

# OR manual backup
mysqldump -u username -p database_name > backup_$(date +%Y%m%d).sql
```

## 📞 Support

If you encounter issues:

1. Check Laravel logs: `storage/logs/laravel.log`
2. Check web server logs
3. Verify Node version: `node --version`
4. Verify PHP version: `php --version`
5. Test build locally before deploying

## ✅ Success!

Your application should now be running on Node 17.9.1! 🎉

Access points:
- **Website**: https://yourdomain.com
- **Login**: https://yourdomain.com/login
- **API Docs**: https://yourdomain.com/api/documentation
